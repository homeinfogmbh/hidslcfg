#! /usr/bin/env python3
"""HOMEINFO Digital Signage Linux configurator.

Maintainer: Richard Neumann <r.neumann@homeinfo.de>

Usage:
    hidslcfg <ident> [options]
    hidslcfg [--tid=<terminal_id>] [--cid=<customer_id>] [options]

Options:
    --tid=<terminal_id>, -T     Specifies the physical terminal identifier.
    --cid=<customer_id>, -C     Specifies the customer identifier.
    --user=<user_name>, -u      Specifies the setup user's name.
    --no-serial-number, -n      Do not prompt to set system's serial number.
    --grace-time=<seconds>, -g  Specifies the grace time to wit for the OpenVPN
                                server to respond.
    --verbose, -v               Be gassy.
    -h --help                   Show this page.
"""
from hidslcfg import confirm_terminal, configure, Client

from docopt import docopt


def main(options):
    OPTIONS['verbose'] = options['--verbose']
    ident = options['<ident>']

    if ident is None:
        tid = options['--tid']
        cid = options['--cid']
    else:
        try:
            tid, cid = ident.split('.')
        except ValueError:
            raise ProgramError(
                'INVALID IDENT', 'Identifier must be like <tid>.<cid>')

    user = options['--user']
    query_serial_number = not options['--no-serial-number']
    gracetime = options['--grace-time']

    if gracetime is not None:
        try:
            OPTIONS['gracetime'] = int(gracetime)
        except ValueError:
            raise ProgramError('Invalid value for grace time: {}.'.format(
                gracetime))

    try:
        if cid is None:
            cid = input('Customer ID: ')
        if tid is None:
            tid = input('Terminal ID: ')
        if user is None:
            user = input('User name: ')

        passwd = getpass('Password: ')
    except EOFError:
        print()
        raise ProgramError('Missing mandatory data.')
    except KeyboardInterrupt:
        print()
        raise ProgramError('Configuration aborted by user.')

    serial_number = None

    with Client(user, passwd, cid, tid) as client:
        confirm_terminal(client.terminal, serial_number=serial_number)

        if serial_number is not None:
            if serial_number:
                print(f'Setting serial number of {tid}.{cid} to '
                      f'"{serial_number}".')
            else:
                print(f'Deleting serial number of {tid}.{cid}.')

            client.set_serial_number(serial_number)

        configure(tid, cid, client.vpndata)


if __name__ == '__main__':
    with ProgramErrorHandler():
        main(docopt(__doc__))
